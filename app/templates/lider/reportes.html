{% extends "base.html" %}

{% block title %}Reportes y Métricas - Synapsis Apoyos{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-chart-bar text-primary"></i> Reportes y Métricas</h2>
                <a href="{{ url_for('lider.dashboard') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Dashboard
                </a>
            </div>
        </div>
    </div>

    <!-- Filtros de fecha -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <form method="GET" class="row g-3">
                        <div class="col-md-4">
                            <label for="fecha_inicio" class="form-label">Fecha Inicio</label>
                            <input type="date" class="form-control" id="fecha_inicio" name="fecha_inicio" 
                                   value="{{ fecha_inicio }}">
                        </div>
                        <div class="col-md-4">
                            <label for="fecha_fin" class="form-label">Fecha Fin</label>
                            <input type="date" class="form-control" id="fecha_fin" name="fecha_fin" 
                                   value="{{ fecha_fin }}">
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary me-2">
                                <i class="fas fa-filter"></i> Filtrar
                            </button>
                            <button type="button" class="btn btn-outline-success" onclick="exportarReporte()">
                                <i class="fas fa-download"></i> Exportar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Métricas principales -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h3 class="mb-0">{{ total_solicitudes }}</h3>
                            <p class="mb-0">Total Solicitudes</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-list fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h3 class="mb-0">{{ solicitudes_aceptadas }}</h3>
                            <p class="mb-0">Aceptadas</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-check-circle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h3 class="mb-0">{{ solicitudes_rechazadas }}</h3>
                            <p class="mb-0">Rechazadas</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-times-circle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h3 class="mb-0">{{ servicios_completados }}</h3>
                            <p class="mb-0">Completados</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-flag-checkered fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Gráfico de solicitudes por día -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-line"></i> Solicitudes por Día</h5>
                </div>
                <div class="card-body">
                    <canvas id="chartSolicitudesDia" height="100"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Tipos de apoyo -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-pie"></i> Tipos de Apoyo</h5>
                </div>
                <div class="card-body">
                    <canvas id="chartTiposApoyo" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Rendimiento por móvil -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-users"></i> Rendimiento por Móvil</h5>
                </div>
                <div class="card-body">
                    {% if rendimiento_moviles %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Móvil</th>
                                        <th>Total Servicios</th>
                                        <th>Completados</th>
                                        <th>Tasa Éxito</th>
                                        <th>Tiempo Promedio</th>
                                        <th>Rendimiento</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for movil in rendimiento_moviles %}
                                    {% set tasa_exito = (movil.completados / movil.total_servicios * 100) if movil.total_servicios > 0 else 0 %}
                                    <tr>
                                        <td>{{ movil.nombre }} {{ movil.apellido }}</td>
                                        <td>{{ movil.total_servicios }}</td>
                                        <td>{{ movil.completados }}</td>
                                        <td>
                                            <span class="badge bg-{{ 'success' if tasa_exito >= 80 else 'warning' if tasa_exito >= 60 else 'danger' }}">
                                                {{ "%.1f"|format(tasa_exito) }}%
                                            </span>
                                        </td>
                                        <td>
                                            {% if movil.duracion_promedio %}
                                                {{ "%.0f"|format(movil.duracion_promedio) }} min
                                            {% else %}
                                                --
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="progress" style="height: 20px;">
                                                <div class="progress-bar bg-{{ 'success' if tasa_exito >= 80 else 'warning' if tasa_exito >= 60 else 'danger' }}" 
                                                     role="progressbar" style="width: {{ tasa_exito }}%">
                                                    {{ "%.0f"|format(tasa_exito) }}%
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No hay datos de rendimiento</h5>
                            <p class="text-muted">No se encontraron servicios en el período seleccionado.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Datos para gráficos
    const solicitudesPorDia = {{ solicitudes_por_dia | tojson }};
    const tiposApoyo = {{ tipos_apoyo | tojson }};
    
    // Gráfico de solicitudes por día
    const ctxDia = document.getElementById('chartSolicitudesDia').getContext('2d');
    new Chart(ctxDia, {
        type: 'line',
        data: {
            labels: solicitudesPorDia.map(item => {
                const fecha = new Date(item.fecha);
                return fecha.toLocaleDateString('es-CO', { month: 'short', day: 'numeric' });
            }),
            datasets: [{
                label: 'Solicitudes',
                data: solicitudesPorDia.map(item => item.cantidad),
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    
    // Gráfico de tipos de apoyo
    const ctxTipos = document.getElementById('chartTiposApoyo').getContext('2d');
    new Chart(ctxTipos, {
        type: 'doughnut',
        data: {
            labels: tiposApoyo.map(item => item.tipo_apoyo.charAt(0).toUpperCase() + item.tipo_apoyo.slice(1)),
            datasets: [{
                data: tiposApoyo.map(item => item.cantidad),
                backgroundColor: [
                    'rgba(255, 99, 132, 0.8)',
                    'rgba(54, 162, 235, 0.8)',
                    'rgba(255, 205, 86, 0.8)',
                    'rgba(75, 192, 192, 0.8)'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
});

function exportarReporte() {
    // Obtener fechas del formulario
    const fechaInicio = document.getElementById('fecha_inicio').value;
    const fechaFin = document.getElementById('fecha_fin').value;
    
    // Mostrar indicador de carga
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generando Excel...';
    btn.disabled = true;
    
    // Construir URL con parámetros
    let url = '{{ url_for("lider.exportar_reportes_excel") }}';
    const params = new URLSearchParams();
    
    if (fechaInicio) {
        params.append('fecha_inicio', fechaInicio);
    }
    if (fechaFin) {
        params.append('fecha_fin', fechaFin);
    }
    
    if (params.toString()) {
        url += '?' + params.toString();
    }
    
    // Crear enlace temporal para descarga
    const link = document.createElement('a');
    link.href = url;
    link.style.display = 'none';
    document.body.appendChild(link);
    
    // Simular click para iniciar descarga
    link.click();
    
    // Limpiar
    document.body.removeChild(link);
    
    // Restaurar botón después de un breve delay
    setTimeout(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }, 2000);
    
    // Mostrar mensaje de éxito
    setTimeout(() => {
        const toast = document.createElement('div');
        toast.className = 'toast-container position-fixed top-0 end-0 p-3';
        toast.innerHTML = `
            <div class="toast show" role="alert">
                <div class="toast-header bg-success text-white">
                    <i class="fas fa-check-circle me-2"></i>
                    <strong class="me-auto">Exportación Exitosa</strong>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
                </div>
                <div class="toast-body">
                    El archivo Excel se ha descargado correctamente.
                </div>
            </div>
        `;
        document.body.appendChild(toast);
        
        // Remover toast después de 5 segundos
        setTimeout(() => {
            if (document.body.contains(toast)) {
                document.body.removeChild(toast);
            }
        }, 5000);
    }, 1000);
}
</script>
{% endblock %}