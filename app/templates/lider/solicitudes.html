{% extends "base.html" %}

{% block title %}Gestión de Solicitudes - Synapsis Apoyos{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-list text-primary"></i> Gestión de Solicitudes</h2>
                <a href="{{ url_for('lider.dashboard') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Dashboard
                </a>
            </div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <form method="GET" class="row g-3">
                        <div class="col-md-2">
                            <label for="localidad" class="form-label">Localidad</label>
                            <select class="form-select" id="localidad" name="localidad">
                                <option value="todas" {{ 'selected' if localidad_filtro == 'todas' else '' }}>Todas las localidades</option>
                                <!-- Las localidades se cargarán dinámicamente -->
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="estado" class="form-label">Estado</label>
                            <select class="form-select" id="estado" name="estado">
                                <option value="todas" {{ 'selected' if estado_filtro == 'todas' else '' }}>Todas</option>
                                <option value="pendiente" {{ 'selected' if estado_filtro == 'pendiente' else '' }}>Pendientes</option>
                                <option value="aceptada" {{ 'selected' if estado_filtro == 'aceptada' else '' }}>Aceptadas</option>
                                <option value="completada" {{ 'selected' if estado_filtro == 'completada' else '' }}>Completadas</option>
                                <option value="rechazada" {{ 'selected' if estado_filtro == 'rechazada' else '' }}>Rechazadas</option>
                                <option value="cancelada" {{ 'selected' if estado_filtro == 'cancelada' else '' }}>Canceladas</option>
                                <option value="expirada" {{ 'selected' if estado_filtro == 'expirada' else '' }}>Expiradas</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="tecnico_id" class="form-label">Técnico</label>
                            <select class="form-select" id="tecnico_id" name="tecnico_id">
                                <option value="">Todos los técnicos</option>
                                {% for tecnico in tecnicos %}
                                <option value="{{ tecnico.id }}" {{ 'selected' if tecnico_filtro == tecnico.id else '' }}>
                                    {{ tecnico.nombre }} {{ tecnico.apellido }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="tipo_apoyo" class="form-label">Tipo de Apoyo</label>
                            <select class="form-select" id="tipo_apoyo" name="tipo_apoyo">
                                <option value="" {{ 'selected' if not tipo_apoyo_filtro else '' }}>Todos</option>
                                <option value="escalera" {{ 'selected' if tipo_apoyo_filtro == 'escalera' else '' }}>Escalera</option>
                                <option value="equipos" {{ 'selected' if tipo_apoyo_filtro == 'equipos' else '' }}>Equipos</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="fecha_desde" class="form-label">Desde</label>
                            <input type="date" class="form-control" id="fecha_desde" name="fecha_desde" value="{{ fecha_desde_filtro or '' }}">
                        </div>
                        <div class="col-md-2">
                            <label for="fecha_hasta" class="form-label">Hasta</label>
                            <input type="date" class="form-control" id="fecha_hasta" name="fecha_hasta" value="{{ fecha_hasta_filtro or '' }}">
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary me-2">
                                <i class="fas fa-filter"></i> Filtrar
                            </button>
                            <button type="button" class="btn btn-outline-warning me-2" onclick="limpiarFiltros()">
                                <i class="fas fa-eraser"></i> Limpiar
                            </button>
                            <button type="button" class="btn btn-outline-success" onclick="exportarSolicitudes()">
                                <i class="fas fa-download"></i> Exportar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Lista de solicitudes -->
    <div class="row">
        <div class="col-12">
            {% if solicitudes.items %}
                {% for solicitud in solicitudes.items %}
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="d-flex align-items-center mb-2">
                                    <h5 class="card-title mb-0 me-3">
                                        <i class="fas fa-{{ 'ladder' if solicitud.tipo_apoyo == 'escalera' else 'tools' }}"></i>
                                        Apoyo de {{ solicitud.tipo_apoyo.title() }} - #{{ solicitud.id }}
                                    </h5>
                                    <span class="badge bg-{{ 
                                        'warning' if solicitud.estado == 'pendiente' else
                                        'success' if solicitud.estado == 'aceptada' else
                                        'primary' if solicitud.estado == 'completada' else
                                        'danger' if solicitud.estado == 'rechazada' else
                                        'secondary' if solicitud.estado == 'cancelada' else
                                        'dark' if solicitud.estado == 'expirada' else
                                        'info'
                                    }}">{{ solicitud.estado.title() }}</span>
                                </div>
                                
                                <div class="row mb-2">
                                    <div class="col-sm-6">
                                        <p class="card-text mb-1">
                                            <strong>Técnico:</strong> {{ solicitud.tecnico.nombre }} {{ solicitud.tecnico.apellido }}
                                        </p>
                                        <p class="card-text mb-1">
                                            <small class="text-muted">
                                                <i class="fas fa-envelope"></i> {{ solicitud.tecnico.email }}
                                                {% if solicitud.tecnico.telefono %}
                                                | <i class="fas fa-phone"></i> {{ solicitud.tecnico.telefono }}
                                                {% endif %}
                                            </small>
                                        </p>
                                    </div>
                                    <div class="col-sm-6">
                                        <p class="card-text mb-1">
                                            <strong>Creada:</strong> {{ solicitud.created_at.strftime('%d/%m/%Y %H:%M') }}
                                        </p>
                                        <p class="card-text mb-1">
                                            <strong>Límite:</strong> 
                                            <span class="{{ 'text-danger' if solicitud.is_expirada() else 'text-muted' }}">
                                                {{ solicitud.limite_tiempo.strftime('%d/%m/%Y %H:%M') }}
                                            </span>
                                        </p>
                                    </div>
                                </div>
                                
                                {% if solicitud.direccion %}
                                <p class="card-text mb-2">
                                    <i class="fas fa-map-marker-alt text-primary"></i> 
                                    {{ solicitud.direccion }}
                                </p>
                                {% endif %}
                                
                                {% if solicitud.observaciones %}
                                <p class="card-text mb-2">
                                    <strong>Observaciones:</strong> {{ solicitud.observaciones }}
                                </p>
                                {% endif %}
                                
                                <!-- Información del servicio si existe -->
                                {% if solicitud.servicio %}
                                <div class="mt-2 p-2 bg-light rounded">
                                    <small class="text-muted">
                                        <strong>Servicio:</strong> 
                                        Atendido por {{ solicitud.servicio.movil.nombre }} {{ solicitud.servicio.movil.apellido }}
                                        {% if solicitud.servicio.aceptado_at %}
                                        | Aceptado: {{ solicitud.servicio.aceptado_at.strftime('%d/%m/%Y %H:%M') }}
                                        {% endif %}
                                        {% if solicitud.servicio.finalizado_at %}
                                        | Finalizado: {{ solicitud.servicio.finalizado_at.strftime('%d/%m/%Y %H:%M') }}
                                        {% endif %}
                                        {% if solicitud.servicio.duracion_minutos %}
                                        | Duración: {{ solicitud.servicio.duracion_minutos }} min
                                        {% endif %}
                                    </small>
                                    {% if solicitud.servicio.observaciones_finales %}
                                    <br><small class="text-muted">
                                        <strong>Observaciones finales:</strong> {{ solicitud.servicio.observaciones_finales }}
                                    </small>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-4 text-end">
                                <div class="mb-2">
                                    <small class="text-muted">
                                        <i class="fas fa-map"></i> 
                                        {{ "%.6f"|format(solicitud.latitud) }}, {{ "%.6f"|format(solicitud.longitud) }}
                                    </small>
                                </div>
                                
                                <div class="btn-group-vertical" role="group">
                                    <button class="btn btn-sm btn-outline-info" 
                                            onclick="verDetalles({{ solicitud.id }})">
                                        <i class="fas fa-eye"></i> Ver Detalles
                                    </button>
                                    
                                    <button class="btn btn-sm btn-outline-primary" 
                                            onclick="abrirMapa({{ solicitud.latitud }}, {{ solicitud.longitud }})">
                                        <i class="fas fa-map"></i> Ver en Mapa
                                    </button>
                                    
                                    {% if solicitud.estado == 'pendiente' %}
                                    <button class="btn btn-sm btn-outline-warning" 
                                            onclick="marcarUrgente({{ solicitud.id }})">
                                        <i class="fas fa-exclamation-triangle"></i> Marcar Urgente
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
                
                <!-- Paginación -->
                {% if solicitudes.pages > 1 %}
                <nav aria-label="Paginación de solicitudes">
                    <ul class="pagination justify-content-center">
                        {% if solicitudes.has_prev %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('lider.solicitudes', page=solicitudes.prev_num, estado=estado_filtro, tecnico_id=tecnico_filtro, localidad=localidad_filtro, tipo_apoyo=tipo_apoyo_filtro, fecha_desde=fecha_desde_filtro, fecha_hasta=fecha_hasta_filtro) }}">
                                <i class="fas fa-chevron-left"></i> Anterior
                            </a>
                        </li>
                        {% endif %}
                        
                        {% for page_num in solicitudes.iter_pages() %}
                            {% if page_num %}
                                {% if page_num != solicitudes.page %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('lider.solicitudes', page=page_num, estado=estado_filtro, tecnico_id=tecnico_filtro, localidad=localidad_filtro, tipo_apoyo=tipo_apoyo_filtro, fecha_desde=fecha_desde_filtro, fecha_hasta=fecha_hasta_filtro) }}">
                                        {{ page_num }}
                                    </a>
                                </li>
                                {% else %}
                                <li class="page-item active">
                                    <span class="page-link">{{ page_num }}</span>
                                </li>
                                {% endif %}
                            {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">...</span>
                            </li>
                            {% endif %}
                        {% endfor %}
                        
                        {% if solicitudes.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('lider.solicitudes', page=solicitudes.next_num, estado=estado_filtro, tecnico_id=tecnico_filtro, localidad=localidad_filtro, tipo_apoyo=tipo_apoyo_filtro, fecha_desde=fecha_desde_filtro, fecha_hasta=fecha_hasta_filtro) }}">
                                Siguiente <i class="fas fa-chevron-right"></i>
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                    <h4 class="text-muted">No se encontraron solicitudes</h4>
                    <p class="text-muted">No hay solicitudes que coincidan con los filtros seleccionados.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal para detalles -->
<div class="modal fade" id="detallesModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-info-circle me-2"></i>Detalles de la Solicitud
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="detallesContent">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="mt-2">Cargando detalles...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-primary" id="btnVerMapa" style="display: none;">
                    <i class="fas fa-map"></i> Ver en Mapa
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<script>
// Cargar localidades al inicializar la página
document.addEventListener('DOMContentLoaded', function() {
    cargarLocalidades();
});

// Función para cargar localidades en el selector
async function cargarLocalidades() {
    try {
        const response = await fetch('/lider/api/localidades');
        if (!response.ok) {
            throw new Error('Error al cargar localidades');
        }
        const data = await response.json();
        
        const selector = document.getElementById('localidad');
        const valorActual = '{{ localidad_filtro }}'; // Obtener el valor actual del filtro
        
        // Limpiar opciones existentes (excepto "Todas")
        while (selector.children.length > 1) {
            selector.removeChild(selector.lastChild);
        }
        
        // Agregar localidades
        data.localidades.forEach(localidad => {
            const option = document.createElement('option');
            option.value = localidad.codigo;
            option.textContent = `${localidad.codigo} - ${localidad.nombre}`;
            
            // Marcar como seleccionado si coincide con el filtro actual
            if (localidad.codigo === valorActual) {
                option.selected = true;
            }
            
            selector.appendChild(option);
        });
        
        console.log('Localidades cargadas:', data.localidades.length);
        console.log('Valor actual del filtro:', valorActual);
    } catch (error) {
        console.error('Error cargando localidades:', error);
    }
}

function verDetalles(solicitudId) {
    // Mostrar modal con spinner de carga
    const modal = new bootstrap.Modal(document.getElementById('detallesModal'));
    modal.show();
    
    // Hacer llamada AJAX para obtener detalles
    fetch(`/lider/api/solicitud/${solicitudId}/detalles`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Error al cargar los detalles');
            }
            return response.json();
        })
        .then(data => {
            mostrarDetalles(data);
        })
        .catch(error => {
            console.error('Error:', error);
            mostrarError();
        });
}

function mostrarDetalles(solicitud) {
    const estadoBadge = getEstadoBadge(solicitud.estado);
    const tipoApoyoBadge = getTipoApoyoBadge(solicitud.tipo_apoyo);
    
    let servicioInfo = '';
    if (solicitud.servicio) {
        const estadoServicio = getEstadoServicioBadge(solicitud.servicio.estado);
        servicioInfo = `
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0"><i class="fas fa-cogs"></i> Información del Servicio</h6>
                    </div>
                    <div class="card-body">
                        <p><strong>Estado:</strong> ${estadoServicio}</p>
                        ${solicitud.servicio.aceptado_at ? `<p><strong>Aceptado:</strong> ${solicitud.servicio.aceptado_at}</p>` : ''}
                        ${solicitud.servicio.finalizado_at ? `<p><strong>Finalizado:</strong> ${solicitud.servicio.finalizado_at}</p>` : ''}
                        ${solicitud.servicio.duracion_minutos ? `<p><strong>Duración:</strong> ${solicitud.servicio.duracion_minutos} minutos</p>` : ''}
                        ${solicitud.servicio.movil ? `
                            <hr>
                            <h6><i class="fas fa-user"></i> Móvil Asignada</h6>
                            <p><strong>Nombre:</strong> ${solicitud.servicio.movil.nombre}</p>
                            <p><strong>Teléfono:</strong> ${solicitud.servicio.movil.telefono}</p>
                        ` : ''}
                        ${solicitud.servicio.observaciones_finales ? `
                            <hr>
                            <h6><i class="fas fa-comment"></i> Observaciones Finales</h6>
                            <p class="text-muted">${solicitud.servicio.observaciones_finales}</p>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
    }
    
    let observacionesInfo = '';
    if (solicitud.observaciones && solicitud.observaciones.length > 0) {
        const observacionesHtml = solicitud.observaciones.map(obs => `
            <div class="border-start border-primary ps-3 mb-2">
                <small class="text-muted">${obs.created_at} - ${obs.usuario}</small>
                <p class="mb-0">${obs.contenido}</p>
            </div>
        `).join('');
        
        observacionesInfo = `
            <div class="col-12 mt-3">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0"><i class="fas fa-comments"></i> Observaciones</h6>
                    </div>
                    <div class="card-body">
                        ${observacionesHtml}
                    </div>
                </div>
            </div>
        `;
    }
    
    const content = `
        <div class="container-fluid">
            <div class="row mb-3">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4><i class="fas fa-clipboard-list"></i> Solicitud #${solicitud.id}</h4>
                        <div>
                            ${estadoBadge}
                            ${tipoApoyoBadge}
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0"><i class="fas fa-info"></i> Información General</h6>
                        </div>
                        <div class="card-body">
                            <p><strong>Descripción:</strong></p>
                            <p class="text-muted">${solicitud.descripcion}</p>
                            <hr>
                            <p><strong>Dirección:</strong> ${solicitud.direccion}</p>
                            <p><strong>Coordenadas:</strong> ${solicitud.latitud.toFixed(6)}, ${solicitud.longitud.toFixed(6)}</p>
                            <p><strong>Creado:</strong> ${solicitud.created_at}</p>
                            ${solicitud.updated_at ? `<p><strong>Actualizado:</strong> ${solicitud.updated_at}</p>` : ''}
                            
                            ${solicitud.tecnico ? `
                                <hr>
                                <h6><i class="fas fa-user-tie"></i> Técnico Solicitante</h6>
                                <p><strong>Nombre:</strong> ${solicitud.tecnico.nombre}</p>
                                <p><strong>Teléfono:</strong> ${solicitud.tecnico.telefono}</p>
                                <p><strong>Email:</strong> ${solicitud.tecnico.email}</p>
                            ` : ''}
                        </div>
                    </div>
                </div>
                
                ${servicioInfo}
            </div>
            
            ${observacionesInfo}
        </div>
    `;
    
    document.getElementById('detallesContent').innerHTML = content;
    
    // Configurar botón de mapa
    const btnMapa = document.getElementById('btnVerMapa');
    btnMapa.style.display = 'inline-block';
    btnMapa.onclick = () => abrirMapa(solicitud.latitud, solicitud.longitud);
}

function mostrarError() {
    const content = `
        <div class="text-center py-4">
            <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
            <h5>Error al cargar los detalles</h5>
            <p class="text-muted">No se pudieron cargar los detalles de la solicitud. Inténtalo de nuevo.</p>
        </div>
    `;
    document.getElementById('detallesContent').innerHTML = content;
    document.getElementById('btnVerMapa').style.display = 'none';
}

function getEstadoBadge(estado) {
    const badges = {
        'pendiente': '<span class="badge bg-warning">Pendiente</span>',
        'aceptada': '<span class="badge bg-info">Aceptada</span>',
        'completada': '<span class="badge bg-success">Completada</span>',
        'rechazada': '<span class="badge bg-danger">Rechazada</span>',
        'cancelada': '<span class="badge bg-secondary">Cancelada</span>',
        'expirada': '<span class="badge bg-dark">Expirada</span>'
    };
    return badges[estado] || `<span class="badge bg-secondary">${estado}</span>`;
}

function getTipoApoyoBadge(tipo) {
    const badges = {
        'tecnico': '<span class="badge bg-primary">Técnico</span>',
        'materiales': '<span class="badge bg-info">Materiales</span>',
        'transporte': '<span class="badge bg-warning">Transporte</span>',
        'emergencia': '<span class="badge bg-danger">Emergencia</span>'
    };
    return badges[tipo] || `<span class="badge bg-secondary">${tipo}</span>`;
}

function getEstadoServicioBadge(estado) {
    const badges = {
        'aceptado': '<span class="badge bg-info">Aceptado</span>',
        'en_ruta': '<span class="badge bg-warning">En Ruta</span>',
        'en_sitio': '<span class="badge bg-primary">En Sitio</span>',
        'completado': '<span class="badge bg-success">Completado</span>',
        'rechazado': '<span class="badge bg-danger">Rechazado</span>'
    };
    return badges[estado] || `<span class="badge bg-secondary">${estado}</span>`;
}

function abrirMapa(latitud, longitud) {
    // Abrir Google Maps con las coordenadas
    const url = `https://www.google.com/maps?q=${latitud},${longitud}`;
    window.open(url, '_blank');
}

function marcarUrgente(solicitudId) {
    if (confirm('¿Marcar esta solicitud como urgente?')) {
        // En una implementación real, aquí se haría una llamada AJAX
        alert(`Solicitud #${solicitudId} marcada como urgente.\n\nFuncionalidad en desarrollo.`);
    }
}

function exportarSolicitudes() {
    const localidad = document.getElementById('localidad').value;
    const estado = document.getElementById('estado').value;
    const tecnico = document.getElementById('tecnico_id').value;
    const tipoApoyo = document.getElementById('tipo_apoyo').value;
    const fechaDesde = document.getElementById('fecha_desde').value;
    const fechaHasta = document.getElementById('fecha_hasta').value;
    
    // Mostrar indicador de carga
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Exportando...';
    btn.disabled = true;
    
    // Construir URL con parámetros
    const params = new URLSearchParams();
    if (localidad && localidad !== 'todas') {
        params.append('localidad', localidad);
    }
    if (estado && estado !== 'todas') {
        params.append('estado', estado);
    }
    if (tecnico) {
        params.append('tecnico_id', tecnico);
    }
    if (tipoApoyo) {
        params.append('tipo_apoyo', tipoApoyo);
    }
    if (fechaDesde) {
        params.append('fecha_desde', fechaDesde);
    }
    if (fechaHasta) {
        params.append('fecha_hasta', fechaHasta);
    }
    
    const url = `/lider/api/solicitudes/export?${params.toString()}`;
    
    // Crear enlace temporal para descargar
    const link = document.createElement('a');
    link.href = url;
    link.download = `solicitudes_export_${new Date().toISOString().slice(0, 10)}.xlsx`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    // Restaurar botón después de un breve delay
    setTimeout(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }, 2000);
}

function limpiarFiltros() {
    // Limpiar todos los campos del formulario
    document.getElementById('localidad').value = 'todas';
    document.getElementById('estado').value = 'todas';
    document.getElementById('tecnico_id').value = '';
    document.getElementById('tipo_apoyo').value = '';
    document.getElementById('fecha_desde').value = '';
    document.getElementById('fecha_hasta').value = '';
    
    // Redirigir a la página sin parámetros para mostrar todas las solicitudes
    window.location.href = '/lider/solicitudes';
}
</script>
{% endblock %}