{% extends "base.html" %}

{% block title %}Diagn√≥stico del Mapa - M√≥vil{% endblock %}

{% block head %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
{% endblock %}

<style>
        .diagnostic-card {
            margin-bottom: 20px;
        }
        .status-ok {
            color: #28a745;
        }
        .status-error {
            color: #dc3545;
        }
        .status-warning {
            color: #ffc107;
        }
        #mapa-diagnostico {
            height: 300px;
            border: 2px solid #007bff;
            border-radius: 8px;
        }
        .log-container {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-stethoscope text-primary"></i> Diagn√≥stico del Mapa - M√≥vil</h2>
                <div>
                    <a href="{{ url_for('movil.mapa') }}" class="btn btn-primary me-2">
                        <i class="fas fa-map"></i> Ir al Mapa Real
                    </a>
                    <a href="{{ url_for('movil.dashboard') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Estado del Sistema -->
        <div class="col-md-6">
            <div class="card diagnostic-card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-info-circle"></i> Estado del Sistema</h5>
                </div>
                <div class="card-body">
                    <div id="system-status">
                        <p><strong>Usuario:</strong> {{ current_user.get_nombre_completo() }}</p>
                        <p><strong>Rol:</strong> {{ current_user.rol }}</p>
                        <p><strong>Estado:</strong> {{ 'Activo' if current_user.activo else 'Inactivo' }}</p>
                        <p><strong>Navegador:</strong> <span id="browser-info">Detectando...</span></p>
                        <p><strong>Geolocalizaci√≥n:</strong> <span id="geolocation-status">Verificando...</span></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Estado de Leaflet -->
        <div class="col-md-6">
            <div class="card diagnostic-card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-leaf"></i> Estado de Leaflet</h5>
                </div>
                <div class="card-body">
                    <div id="leaflet-status">
                        <p><strong>Leaflet Cargado:</strong> <span id="leaflet-loaded">Verificando...</span></p>
                        <p><strong>Versi√≥n:</strong> <span id="leaflet-version">N/A</span></p>
                        <p><strong>Routing Machine:</strong> <span id="routing-loaded">Verificando...</span></p>
                        <p><strong>CSS Cargado:</strong> <span id="css-loaded">Verificando...</span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Mapa de Prueba -->
        <div class="col-md-8">
            <div class="card diagnostic-card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-map"></i> Mapa de Prueba</h5>
                </div>
                <div class="card-body">
                    <div id="mapa-diagnostico"></div>
                    <div class="mt-3">
                        <button class="btn btn-sm btn-primary" onclick="reiniciarMapa()">
                            <i class="fas fa-redo"></i> Reiniciar Mapa
                        </button>
                        <button class="btn btn-sm btn-success" onclick="centrarEnBogota()">
                            <i class="fas fa-crosshairs"></i> Centrar en Bogot√°
                        </button>
                        <button class="btn btn-sm btn-info" onclick="obtenerUbicacion()">
                            <i class="fas fa-location-arrow"></i> Mi Ubicaci√≥n
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Log de Eventos -->
        <div class="col-md-4">
            <div class="card diagnostic-card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="fas fa-list"></i> Log de Eventos</h5>
                </div>
                <div class="card-body">
                    <div id="event-log" class="log-container"></div>
                    <button class="btn btn-sm btn-outline-secondary mt-2" onclick="limpiarLog()">
                        <i class="fas fa-trash"></i> Limpiar Log
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

<script>
let mapaTest = null;
let logContainer = null;

function log(message, type = 'info') {
    const timestamp = new Date().toLocaleTimeString();
    const logEntry = document.createElement('div');
    logEntry.innerHTML = `<span class="text-muted">[${timestamp}]</span> ${message}`;
    
    if (type === 'error') {
        logEntry.className = 'text-danger';
    } else if (type === 'success') {
        logEntry.className = 'text-success';
    } else if (type === 'warning') {
        logEntry.className = 'text-warning';
    }
    
    logContainer.appendChild(logEntry);
    logContainer.scrollTop = logContainer.scrollHeight;
}

function limpiarLog() {
    logContainer.innerHTML = '';
}

function verificarSistema() {
    log('üîç Iniciando diagn√≥stico del sistema...');
    
    // Verificar navegador
    const browserInfo = navigator.userAgent;
    document.getElementById('browser-info').textContent = browserInfo.split(' ')[0];
    log(`Navegador: ${browserInfo.split(' ')[0]}`);
    
    // Verificar geolocalizaci√≥n
    if (navigator.geolocation) {
        document.getElementById('geolocation-status').innerHTML = '<span class="status-ok">‚úÖ Disponible</span>';
        log('‚úÖ Geolocalizaci√≥n disponible', 'success');
    } else {
        document.getElementById('geolocation-status').innerHTML = '<span class="status-error">‚ùå No disponible</span>';
        log('‚ùå Geolocalizaci√≥n no disponible', 'error');
    }
}

function verificarLeaflet() {
    log('üçÉ Verificando Leaflet...');
    
    // Verificar si Leaflet est√° cargado
    if (typeof L !== 'undefined') {
        document.getElementById('leaflet-loaded').innerHTML = '<span class="status-ok">‚úÖ Cargado</span>';
        document.getElementById('leaflet-version').textContent = L.version || 'Desconocida';
        log(`‚úÖ Leaflet cargado (v${L.version})`, 'success');
        
        // Verificar Routing Machine
        if (typeof L.Routing !== 'undefined') {
            document.getElementById('routing-loaded').innerHTML = '<span class="status-ok">‚úÖ Cargado</span>';
            log('‚úÖ Leaflet Routing Machine cargado', 'success');
        } else {
            document.getElementById('routing-loaded').innerHTML = '<span class="status-error">‚ùå No cargado</span>';
            log('‚ùå Leaflet Routing Machine no cargado', 'error');
        }
    } else {
        document.getElementById('leaflet-loaded').innerHTML = '<span class="status-error">‚ùå No cargado</span>';
        log('‚ùå Leaflet no est√° cargado', 'error');
        return false;
    }
    
    // Verificar CSS
    const leafletCSS = document.querySelector('link[href*="leaflet.css"]');
    if (leafletCSS) {
        document.getElementById('css-loaded').innerHTML = '<span class="status-ok">‚úÖ Cargado</span>';
        log('‚úÖ CSS de Leaflet cargado', 'success');
    } else {
        document.getElementById('css-loaded').innerHTML = '<span class="status-warning">‚ö†Ô∏è No detectado</span>';
        log('‚ö†Ô∏è CSS de Leaflet no detectado', 'warning');
    }
    
    return true;
}

function inicializarMapaTest() {
    log('üó∫Ô∏è Inicializando mapa de prueba...');
    
    try {
        if (mapaTest) {
            mapaTest.remove();
            log('üîÑ Mapa anterior removido');
        }
        
        // Crear mapa
        mapaTest = L.map('mapa-diagnostico').setView([4.6097, -74.0817], 13);
        log('‚úÖ Mapa inicializado', 'success');
        
        // Agregar tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(mapaTest);
        log('‚úÖ Tiles agregados', 'success');
        
        // Agregar marcador
        L.marker([4.6097, -74.0817])
            .addTo(mapaTest)
            .bindPopup('¬°Mapa funcionando correctamente!')
            .openPopup();
        log('‚úÖ Marcador agregado', 'success');
        
        // Eventos del mapa
        mapaTest.on('click', function(e) {
            log(`üìç Click en: ${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}`);
        });
        
        mapaTest.on('zoomend', function() {
            log(`üîç Zoom cambiado a: ${mapaTest.getZoom()}`);
        });
        
        log('üéâ Mapa de prueba completamente funcional', 'success');
        
    } catch (error) {
        log(`‚ùå Error inicializando mapa: ${error.message}`, 'error');
        console.error('Error del mapa:', error);
    }
}

function reiniciarMapa() {
    log('üîÑ Reiniciando mapa...');
    inicializarMapaTest();
}

function centrarEnBogota() {
    if (mapaTest) {
        mapaTest.setView([4.6097, -74.0817], 13);
        log('üìç Mapa centrado en Bogot√°');
    }
}

function obtenerUbicacion() {
    log('üìç Obteniendo ubicaci√≥n actual...');
    
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                
                log(`‚úÖ Ubicaci√≥n obtenida: ${lat.toFixed(4)}, ${lng.toFixed(4)}`, 'success');
                
                if (mapaTest) {
                    mapaTest.setView([lat, lng], 15);
                    L.marker([lat, lng])
                        .addTo(mapaTest)
                        .bindPopup('Tu ubicaci√≥n actual')
                        .openPopup();
                    log('üìç Mapa centrado en tu ubicaci√≥n', 'success');
                }
            },
            function(error) {
                log(`‚ùå Error obteniendo ubicaci√≥n: ${error.message}`, 'error');
            }
        );
    } else {
        log('‚ùå Geolocalizaci√≥n no disponible', 'error');
    }
}

// Inicializaci√≥n
document.addEventListener('DOMContentLoaded', function() {
    logContainer = document.getElementById('event-log');
    
    log('üöÄ Iniciando diagn√≥stico completo...');
    
    verificarSistema();
    
    if (verificarLeaflet()) {
        setTimeout(inicializarMapaTest, 500);
    } else {
        log('‚ùå No se puede inicializar el mapa sin Leaflet', 'error');
    }
});
</script>
{% endblock %}