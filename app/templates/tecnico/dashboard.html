{% extends "base.html" %}

{% block title %}Dashboard T√©cnico - Synapsis Apoyos{% endblock %}

{% block extra_css %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>

<style>
    .map-container {
        height: 400px;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .solicitud-card {
        border-left: 4px solid var(--primary-color);
        transition: all 0.3s ease;
    }
    
    .solicitud-card:hover {
        transform: translateY(-2px);
    }
    
    .movil-marker {
        background-color: var(--success-color);
        color: white;
        padding: 8px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        margin-bottom: 5px;
        display: inline-block;
    }
    
    .quick-action-btn {
        width: 100%;
        margin-bottom: 10px;
        padding: 15px;
        font-size: 1.1rem;
        border-radius: 12px;
    }
    
    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
    }
    
    .status-pendiente .status-indicator {
        background-color: var(--warning-color);
    }
    
    .status-aceptada .status-indicator {
        background-color: var(--success-color);
    }
    
    .status-completada .status-indicator {
        background-color: var(--info-color);
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Columna Principal -->
    <div class="col-lg-8">
        <!-- Acciones R√°pidas -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-bolt me-2"></i>
                    Acciones R√°pidas
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <a href="{{ url_for('tecnico.nueva_solicitud') }}" class="btn btn-primary quick-action-btn">
                            <i class="fas fa-plus me-2"></i>
                            Nueva Solicitud de Apoyo
                        </a>
                    </div>
                    <div class="col-md-6">
                        <a href="{{ url_for('tecnico.mapa') }}" class="btn btn-outline-primary quick-action-btn">
                            <i class="fas fa-map me-2"></i>
                            Ver Mapa en Tiempo Real
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Mapa de M√≥viles Cercanas -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-map-marker-alt me-2"></i>
                    M√≥viles Cercanas
                </h5>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-primary" id="actualizarMoviles">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="soloDisponibles">
                        <label class="form-check-label" for="soloDisponibles">
                            <small>Solo disponibles</small>
                        </label>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <!-- Estad√≠sticas r√°pidas -->
                <div class="row mb-3" id="estadisticasMoviles">
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="h4 text-success mb-0" id="contadorDisponibles">-</div>
                            <small class="text-muted">Disponibles</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="h4 text-warning mb-0" id="contadorOcupadas">-</div>
                            <small class="text-muted">Ocupadas</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="h4 text-primary mb-0" id="contadorTotal">-</div>
                            <small class="text-muted">Total</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="h4 text-info mb-0" id="radioActual">20</div>
                            <small class="text-muted">Radio (km)</small>
                        </div>
                    </div>
                </div>
                
                <!-- Lista de m√≥viles cercanas -->
                <div id="listaMovilesCercanas" class="mb-3">
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-spinner fa-spin"></i> Cargando m√≥viles cercanas...
                    </div>
                </div>
                
                <div id="map" class="map-container"></div>
                
                <!-- Leyenda del Mapa -->
                <div class="mt-3 mb-3">
                    <div class="card border-0 bg-light">
                        <div class="card-body p-2">
                            <h6 class="card-title mb-2 text-center">
                                <i class="fas fa-map-signs me-1"></i>
                                Leyenda del Mapa
                            </h6>
                            <div class="row g-2 small">
                                <div class="col-6">
                                    <div class="d-flex align-items-center mb-1">
                                        <div style="width: 12px; height: 12px; background-color: #8e44ad; border-radius: 50%; margin-right: 6px;"></div>
                                        <span><strong>T√©cnico</strong> (Usted)</span>
                                    </div>
                                    <div class="d-flex align-items-center mb-1">
                                        <div style="width: 12px; height: 12px; background-color: #27ae60; border-radius: 50%; margin-right: 6px;"></div>
                                        <span>M√≥vil Disponible</span>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="d-flex align-items-center mb-1">
                                        <div style="width: 12px; height: 12px; background-color: #e74c3c; border-radius: 50%; margin-right: 6px;"></div>
                                        <span>M√≥vil Ocupada</span>
                                    </div>
                                    <div class="d-flex align-items-center mb-1">
                                        <div style="width: 12px; height: 12px; background-color: #95a5a6; border-radius: 50%; margin-right: 6px;"></div>
                                        <span>M√≥vil Desconectada</span>
                                    </div>
                                </div>
                            </div>
                            <div class="text-center mt-2">
                                <small class="text-muted">
                                    <i class="fas fa-wifi me-1"></i>
                                    Conexi√≥n: Activa &lt; 15 min | Desconectada &gt; 15 min
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-3 d-flex justify-content-between align-items-center">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Actualizaci√≥n autom√°tica cada 30 segundos
                    </small>
                    <small class="text-muted" id="ultimaActualizacionMoviles">
                        √öltima actualizaci√≥n: --:--
                    </small>
                </div>
            </div>
        </div>
        
        <!-- Solicitudes Recientes -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-history me-2"></i>
                    Mis Solicitudes Recientes
                </h5>
                <a href="{{ url_for('tecnico.historial') }}" class="btn btn-sm btn-outline-primary">
                    Ver Todas
                </a>
            </div>
            <div class="card-body">
                {% if solicitudes %}
                    {% for solicitud in solicitudes %}
                        <div class="solicitud-card card mb-3">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <div class="d-flex align-items-center mb-2">
                                            <span class="status-{{ solicitud.estado }}">
                                                <span class="status-indicator"></span>
                                                {{ solicitud.estado.title() }}
                                            </span>
                                            <span class="badge bg-secondary ms-2">
                                                {{ solicitud.tipo_apoyo.title() }}
                                            </span>
                                        </div>
                                        <h6 class="mb-1">
                                            Solicitud #{{ solicitud.id }}
                                        </h6>
                                        <p class="text-muted mb-1">
                                            <i class="fas fa-clock me-1"></i>
                                            {{ format_bogota_time(solicitud.created_at, '%d/%m/%Y %H:%M') }}
                                        </p>
                                        {% if solicitud.observaciones %}
                                            <p class="mb-0">
                                                <small>{{ solicitud.observaciones[:100] }}{% if solicitud.observaciones|length > 100 %}...{% endif %}</small>
                                            </p>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-4 text-end">
                                        {% if solicitud.estado == 'pendiente' %}
                                            <div class="mb-2">
                                                <small class="text-warning">
                                                    <i class="fas fa-hourglass-half me-1"></i>
                                                    Expira en: {{ (solicitud.limite_tiempo - solicitud.created_at).total_seconds() // 3600 | int }}h
                                                </small>
                                            </div>
                                            <form method="POST" action="{{ url_for('tecnico.cancelar_solicitud', solicitud_id=solicitud.id) }}" class="d-inline">
                                                <button type="submit" class="btn btn-sm btn-outline-danger" 
                                                        onclick="return confirm('¬øEst√°s seguro de cancelar esta solicitud?')">
                                                    <i class="fas fa-times me-1"></i>
                                                    Cancelar
                                                </button>
                                            </form>
                                        {% elif solicitud.estado == 'aceptada' and solicitud.servicio %}
                                            <div class="text-success">
                                                <i class="fas fa-check-circle me-1"></i>
                                                Atendida por: {{ solicitud.servicio.movil.get_nombre_completo() }}
                                            </div>
                                            <small class="text-muted">
                                                Estado: {{ solicitud.servicio.estado_servicio.replace('_', ' ').title() }}
                                            </small>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <h6 class="text-muted">No tienes solicitudes recientes</h6>
                        <p class="text-muted">Crea tu primera solicitud de apoyo</p>
                        <a href="{{ url_for('tecnico.nueva_solicitud') }}" class="btn btn-primary">
                            <i class="fas fa-plus me-2"></i>
                            Nueva Solicitud
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Estado Actual -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-user me-2"></i>
                    Mi Estado
                </h6>
            </div>
            <div class="card-body">
                <div class="text-center">
                    <div class="mb-3">
                        <i class="fas fa-hard-hat fa-3x text-primary"></i>
                    </div>
                    <h6>{{ current_user.get_nombre_completo() }}</h6>
                    <span class="badge bg-primary">T√©cnico</span>
                    <hr>
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="h4 text-primary mb-0">{{ estadisticas.total_solicitudes }}</div>
                            <small class="text-muted">Total Solicitudes</small>
                        </div>
                        <div class="col-6">
                            <div class="h4 text-success mb-0">{{ estadisticas.moviles_cercanas_count }}</div>
                            <small class="text-muted">M√≥viles Cerca</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Estad√≠sticas del T√©cnico -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h6 class="mb-0 text-center">
                    <i class="fas fa-chart-bar me-2"></i>
                    üìä Estad√≠sticas
                </h6>
            </div>
            <div class="card-body p-0">
                <div class="row g-0 text-center">
                    <div class="col-6 border-end border-bottom p-3">
                        <div class="h2 text-primary mb-0">{{ estadisticas.total_solicitudes }}</div>
                        <small class="text-muted">Total Apoyos</small>
                    </div>
                    <div class="col-6 border-bottom p-3">
                        <div class="h2 text-success mb-0">{{ estadisticas.completadas }}</div>
                        <small class="text-muted">Completados</small>
                    </div>
                    <div class="col-6 border-end p-3">
                        <div class="h2 text-warning mb-0">{{ estadisticas.en_curso }}</div>
                        <small class="text-muted">En Curso</small>
                    </div>
                    <div class="col-6 p-3">
                        <div class="h2 text-info mb-0">{{ estadisticas.disponibles }}</div>
                        <small class="text-muted">Disponibles</small>
                    </div>
                </div>
                
                <!-- Informaci√≥n adicional -->
                <div class="border-top p-3">
                    <div class="row text-center small">
                        <div class="col-12 mb-2">
                            <i class="fas fa-calendar-alt text-muted me-1"></i>
                            <span class="text-muted">
                                Miembro desde 
                                {% if estadisticas.fecha_registro %}
                                    {{ estadisticas.fecha_registro.strftime('%B %Y') }}
                                {% else %}
                                    Septiembre 2025
                                {% endif %}
                            </span>
                        </div>
                        {% if estadisticas.tiempo_promedio_respuesta %}
                        <div class="col-12 mb-2">
                            <i class="fas fa-clock text-muted me-1"></i>
                            <span class="text-muted">
                                Tiempo promedio de respuesta: {{ estadisticas.tiempo_promedio_respuesta }} min
                            </span>
                        </div>
                        {% endif %}
                        {% if estadisticas.por_tipo %}
                        <div class="col-12">
                            <i class="fas fa-tools text-muted me-1"></i>
                            <span class="text-muted">
                                Tipos: 
                                {% for tipo, cantidad in estadisticas.por_tipo.items() %}
                                    {{ tipo.title() }} ({{ cantidad }}){% if not loop.last %}, {% endif %}
                                {% endfor %}
                            </span>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- M√≥viles Cercanas -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-truck me-2"></i>
                    M√≥viles Disponibles
                </h6>
            </div>
            <div class="card-body">
                {% if moviles_cercanas %}
                    {% for item in moviles_cercanas %}
                        <div class="d-flex align-items-center mb-3">
                            <div class="me-3">
                                <i class="fas fa-truck text-success"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="mb-0">{{ item.usuario.get_nombre_completo() }}</h6>
                                <small class="text-muted">
                                    <i class="fas fa-map-marker-alt me-1"></i>
                                    {{ "%.1f"|format(item.distancia_km) }} km
                                </small>
                            </div>
                            <div>
                                <span class="movil-marker">
                                    Disponible
                                </span>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-3">
                        <i class="fas fa-search fa-2x text-muted mb-2"></i>
                        <p class="text-muted mb-0">No hay m√≥viles cercanas</p>
                        <small class="text-muted">Radio de b√∫squeda: 20 km</small>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Ayuda R√°pida -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-question-circle me-2"></i>
                    Ayuda R√°pida
                </h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <h6 class="text-primary">¬øC√≥mo solicitar apoyo?</h6>
                    <ol class="small">
                        <li>Haz clic en "Nueva Solicitud"</li>
                        <li>Selecciona el tipo de apoyo</li>
                        <li>Confirma tu ubicaci√≥n</li>
                        <li>Espera a que una m√≥vil acepte</li>
                    </ol>
                </div>
                <div class="mb-3">
                    <h6 class="text-info">Estados de Solicitud</h6>
                    <ul class="small list-unstyled">
                        <li><span class="status-indicator" style="background-color: var(--warning-color);"></span>Pendiente: Esperando m√≥vil</li>
                        <li><span class="status-indicator" style="background-color: var(--success-color);"></span>Aceptada: M√≥vil en camino</li>
                        <li><span class="status-indicator" style="background-color: var(--info-color);"></span>Completada: Apoyo finalizado</li>
                    </ul>
                </div>
                <div class="alert alert-warning alert-sm">
                    <i class="fas fa-exclamation-triangle me-1"></i>
                    <small>Las solicitudes expiran en 2 horas si no son atendidas.</small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Leaflet JavaScript -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

 <script>
     // Inicializar mapa
     let map;
     let markers = [];
     let marcadoresMoviles = [];
     let userMarker;
     
     function initMap() {
         // Coordenadas por defecto (Bogot√°)
         const defaultLocation = [4.6097, -74.0817];
         
         // Inicializar mapa Leaflet
         map = L.map('map').setView(defaultLocation, 12);
         
         // Agregar capa de OpenStreetMap
         L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
             attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
             maxZoom: 19
         }).addTo(map);
         
         // Obtener ubicaci√≥n actual del usuario
         if (navigator.geolocation) {
             navigator.geolocation.getCurrentPosition(
                 (position) => {
                     const userLocation = [position.coords.latitude, position.coords.longitude];
                     
                     map.setView(userLocation, 13);
                     
                     // Marcador del t√©cnico con icono distintivo y informaci√≥n mejorada
                     userMarker = L.marker(userLocation, {
                         icon: L.icon({
                             iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-violet.png',
                             shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                             iconSize: [30, 49], // Ligeramente m√°s grande para destacar
                             iconAnchor: [15, 49],
                             popupAnchor: [1, -42],
                             shadowSize: [49, 49]
                         })
                     }).addTo(map);
                     
                     const ahora = new Date();
                     const tecnicoPopup = `
                         <div style="min-width: 220px; font-family: Arial, sans-serif;">
                             <h4 style="margin: 0 0 12px 0; color: #8e44ad; text-align: center; border-bottom: 2px solid #8e44ad; padding-bottom: 5px;">
                                 üîß T√âCNICO EN SERVICIO
                             </h4>
                             <div style="margin-bottom: 10px;">
                                 <strong>üë§ Nombre:</strong> {{ current_user.get_nombre_completo() }}
                             </div>
                             <div style="margin-bottom: 10px;">
                                 <strong>üÜî ID:</strong> {{ current_user.id }}
                             </div>
                             <div style="margin-bottom: 10px;">
                                 <strong>üìß Email:</strong> {{ current_user.email }}
                             </div>
                             <div style="margin-bottom: 10px;">
                                 <strong>üü¢ Estado:</strong> 
                                 <span style="color: #27ae60; font-weight: bold;">ACTIVO EN L√çNEA</span>
                             </div>
                             <div style="margin-bottom: 10px;">
                                 <strong>üìç Coordenadas:</strong><br>
                                 <small style="color: #666;">
                                     Lat: ${userLocation[0].toFixed(6)}<br>
                                     Lng: ${userLocation[1].toFixed(6)}
                                 </small>
                             </div>
                             <div style="margin-bottom: 10px;">
                                 <strong>üïí Sesi√≥n iniciada:</strong><br>
                                 <small style="color: #666;">${ahora.toLocaleDateString()} ${ahora.toLocaleTimeString()}</small>
                             </div>
                             <div style="margin-bottom: 10px;">
                                 <strong>üîÑ √öltima actualizaci√≥n:</strong><br>
                                 <small style="color: #666;" id="ultima-actualizacion-tecnico">${ahora.toLocaleTimeString()}</small>
                             </div>
                             <div style="margin-top: 12px; padding-top: 8px; border-top: 1px solid #eee; text-align: center;">
                                 <small style="color: #8e44ad; font-weight: bold;">
                                     üì° Ubicaci√≥n GPS Activa
                                 </small>
                             </div>
                         </div>
                     `;
                     
                     userMarker.bindPopup(tecnicoPopup).openPopup();
                     
                     // Cargar m√≥viles cercanas
                     cargarMovilesCercanas(userLocation[0], userLocation[1]);
                 },
                 () => {
                     // Si no se puede obtener ubicaci√≥n, cargar m√≥viles con ubicaci√≥n por defecto
                     cargarMovilesCercanas(defaultLocation[0], defaultLocation[1]);
                 }
             );
         } else {
             cargarMovilesCercanas(defaultLocation[0], defaultLocation[1]);
         }
     }

    function cargarMovilesCercanas(lat, lng) {
        const soloDisponibles = document.getElementById('soloDisponibles').checked;
        const url = `/tecnico/api/moviles-cercanas?lat=${lat}&lng=${lng}&radio=20&solo_disponibles=${soloDisponibles}`;
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Actualizar estad√≠sticas
                    document.getElementById('contadorDisponibles').textContent = data.estadisticas.disponibles;
                    document.getElementById('contadorOcupadas').textContent = data.estadisticas.ocupadas;
                    document.getElementById('contadorTotal').textContent = data.estadisticas.total;
                    document.getElementById('radioActual').textContent = data.estadisticas.radio_km;
                    
                    // Actualizar lista de m√≥viles
                    mostrarListaMoviles(data.moviles);
                    
                    // Actualizar mapa (si est√° disponible)
                    if (typeof map !== 'undefined' && map) {
                        actualizarMarcadoresMapa(data.moviles);
                    }
                    
                    // Actualizar timestamp
                    const ahora = new Date();
                    document.getElementById('ultimaActualizacionMoviles').textContent = 
                        `√öltima actualizaci√≥n: ${ahora.toLocaleTimeString()}`;
                } else {
                    console.error('Error en respuesta:', data.error);
                    mostrarErrorMoviles(data.error);
                }
            })
            .catch(error => {
                console.error('Error cargando m√≥viles:', error);
                mostrarErrorMoviles('Error de conexi√≥n');
            });
    }
    
    function mostrarListaMoviles(moviles) {
        const container = document.getElementById('listaMovilesCercanas');
        
        if (moviles.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted py-3">
                    <i class="fas fa-search me-2"></i>
                    No hay m√≥viles cercanas en este momento
                </div>
            `;
            return;
        }
        
        let html = '<div class="row g-2">';
        
        moviles.forEach(movil => {
            const estadoClass = movil.estado === 'disponible' ? 'success' : 'warning';
            const estadoIcon = movil.estado === 'disponible' ? 'check-circle' : 'clock';
            const prioridadClass = {
                'alta': 'danger',
                'media': 'warning', 
                'baja': 'info'
            }[movil.prioridad] || 'secondary';
            
            html += `
                <div class="col-md-6">
                    <div class="card border-${estadoClass} h-100">
                        <div class="card-body p-2">
                            <div class="d-flex justify-content-between align-items-start mb-1">
                                <h6 class="card-title mb-0 small">${movil.nombre}</h6>
                                <span class="badge bg-${prioridadClass} badge-sm">${movil.prioridad}</span>
                            </div>
                            <div class="d-flex align-items-center mb-1">
                                <i class="fas fa-${estadoIcon} text-${estadoClass} me-1"></i>
                                <small class="text-${estadoClass} fw-bold">${movil.estado.toUpperCase()}</small>
                            </div>
                            <div class="row g-1 small text-muted">
                                <div class="col-6">
                                    <i class="fas fa-route me-1"></i>${movil.distancia_km} km
                                </div>
                                <div class="col-6">
                                    <i class="fas fa-clock me-1"></i>${movil.tiempo_estimado_min} min
                                </div>
                                <div class="col-12">
                                    <i class="fas fa-phone me-1"></i>${movil.telefono || 'N/A'}
                                </div>
                                ${movil.servicio_activo ? `
                                <div class="col-12">
                                    <i class="fas fa-tools me-1"></i>
                                    <small class="text-warning">Atendiendo: ${movil.servicio_activo.tipo_apoyo}</small>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        container.innerHTML = html;
    }
    
    function mostrarErrorMoviles(error) {
        const container = document.getElementById('listaMovilesCercanas');
        container.innerHTML = `
            <div class="text-center text-danger py-3">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Error: ${error}
            </div>
        `;
        
        // Resetear estad√≠sticas
        document.getElementById('contadorDisponibles').textContent = '-';
        document.getElementById('contadorOcupadas').textContent = '-';
        document.getElementById('contadorTotal').textContent = '-';
    }
    
    // Funci√≥n para actualizar marcadores en el mapa
    function actualizarMarcadoresMapa(moviles) {
        if (!map) return;
        
        // Limpiar marcadores existentes de m√≥viles
        marcadoresMoviles.forEach(marker => {
            map.removeLayer(marker);
        });
        marcadoresMoviles = [];
        
        // Agregar nuevos marcadores
        moviles.forEach(movil => {
            // Determinar el icono basado en estado y conexi√≥n
            let iconUrl, iconColor;
            
            if (!movil.activa_recientemente) {
                // M√≥vil desconectada (m√°s de 15 minutos sin actividad)
                iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-grey.png';
                iconColor = 'grey';
            } else if (movil.estado === 'disponible') {
                // M√≥vil conectada y disponible
                iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png';
                iconColor = 'green';
            } else {
                // M√≥vil conectada pero ocupada
                iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png';
                iconColor = 'red';
            }
            
            const customIcon = L.icon({
                iconUrl: iconUrl,
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });
            
            // Crear contenido del popup con informaci√≥n de conexi√≥n
            const estadoConexion = movil.activa_recientemente ? 
                `<span style="color: green;">üü¢ Conectada</span>` : 
                `<span style="color: red;">üî¥ Desconectada</span>`;
            
            const tiempoUltimaActualizacion = movil.tiempo_desde_actualizacion < 60 ? 
                `${movil.tiempo_desde_actualizacion} min` : 
                `${Math.floor(movil.tiempo_desde_actualizacion / 60)}h ${movil.tiempo_desde_actualizacion % 60}min`;
            
            let popupContent = `
                <div style="min-width: 200px;">
                    <h4 style="margin: 0 0 10px 0; color: #333;">
                        üöó ${movil.conductor_nombre}
                    </h4>
                    <div style="margin-bottom: 8px;">
                        <strong>Estado:</strong> 
                        <span style="color: ${movil.estado === 'disponible' ? 'green' : 'orange'};">
                            ${movil.estado === 'disponible' ? '‚úÖ Disponible' : '‚è≥ Ocupada'}
                        </span>
                    </div>
                    <div style="margin-bottom: 8px;">
                        <strong>Conexi√≥n:</strong> ${estadoConexion}
                    </div>
                    <div style="margin-bottom: 8px;">
                        <strong>√öltima actualizaci√≥n:</strong> ${tiempoUltimaActualizacion}
                    </div>
                    <div style="margin-bottom: 8px;">
                        <strong>Distancia:</strong> ${movil.distancia_km.toFixed(1)} km
                    </div>
                    <div style="margin-bottom: 8px;">
                        <strong>Tiempo estimado:</strong> ${movil.tiempo_estimado_min} min
                    </div>
                    <div style="margin-bottom: 8px;">
                        <strong>Prioridad:</strong> 
                        <span style="color: ${movil.prioridad === 'alta' ? 'red' : movil.prioridad === 'media' ? 'orange' : 'green'};">
                            ${movil.prioridad.charAt(0).toUpperCase() + movil.prioridad.slice(1)}
                        </span>
                    </div>
            `;
            
            // Agregar informaci√≥n del servicio activo si existe
            if (movil.servicio_activo) {
                popupContent += `
                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee;">
                        <strong>Servicio Activo:</strong><br>
                        <small>
                            Tipo: ${movil.servicio_activo.tipo_apoyo || 'N/A'}<br>
                            Estado: ${movil.servicio_activo.estado}
                        </small>
                    </div>
                `;
            }
            
            popupContent += '</div>';
            
            const marker = L.marker([movil.lat, movil.lng], { icon: customIcon })
                .bindPopup(popupContent);
            
            marker.addTo(map);
            marcadoresMoviles.push(marker);
        });
    }
    

    
    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
        // Bot√≥n actualizar m√≥viles
        const btnActualizarMoviles = document.getElementById('actualizarMoviles');
        if (btnActualizarMoviles) {
            btnActualizarMoviles.addEventListener('click', function() {
                this.disabled = true;
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        position => {
                            cargarMovilesCercanas(position.coords.latitude, position.coords.longitude);
                            this.disabled = false;
                            this.innerHTML = '<i class="fas fa-sync-alt"></i>';
                        },
                        error => {
                            cargarMovilesCercanas(4.6097, -74.0817);
                            this.disabled = false;
                            this.innerHTML = '<i class="fas fa-sync-alt"></i>';
                        }
                    );
                } else {
                    cargarMovilesCercanas(4.6097, -74.0817);
                    this.disabled = false;
                    this.innerHTML = '<i class="fas fa-sync-alt"></i>';
                }
            });
        }
        
        // Toggle solo disponibles
        const soloDisponibles = document.getElementById('soloDisponibles');
        if (soloDisponibles) {
            soloDisponibles.addEventListener('change', function() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        position => {
                            cargarMovilesCercanas(position.coords.latitude, position.coords.longitude);
                        },
                        error => {
                            cargarMovilesCercanas(4.6097, -74.0817);
                        }
                    );
                } else {
                    cargarMovilesCercanas(4.6097, -74.0817);
                }
            });
        }
    });

    // Actualizar ubicaciones cada 30 segundos
    setInterval(() => {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    // Actualizar marcador del usuario
                    if (userMarker) {
                        const newLocation = [position.coords.latitude, position.coords.longitude];
                        userMarker.setLatLng(newLocation);
                        map.setView(newLocation, map.getZoom());
                        
                        // Actualizar popup del t√©cnico con nueva informaci√≥n
                        const ahora = new Date();
                        const tecnicoPopupActualizado = `
                            <div style="min-width: 220px; font-family: Arial, sans-serif;">
                                <h4 style="margin: 0 0 12px 0; color: #8e44ad; text-align: center; border-bottom: 2px solid #8e44ad; padding-bottom: 5px;">
                                    üîß T√âCNICO EN SERVICIO
                                </h4>
                                <div style="margin-bottom: 10px;">
                                    <strong>üë§ Nombre:</strong> {{ current_user.get_nombre_completo() }}
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong>üÜî ID:</strong> {{ current_user.id }}
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong>üìß Email:</strong> {{ current_user.email }}
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong>üü¢ Estado:</strong> 
                                    <span style="color: #27ae60; font-weight: bold;">ACTIVO EN L√çNEA</span>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong>üìç Coordenadas:</strong><br>
                                    <small style="color: #666;">
                                        Lat: ${newLocation[0].toFixed(6)}<br>
                                        Lng: ${newLocation[1].toFixed(6)}
                                    </small>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong>üïí Sesi√≥n iniciada:</strong><br>
                                    <small style="color: #666;">${ahora.toLocaleDateString()} ${ahora.toLocaleTimeString()}</small>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong>üîÑ √öltima actualizaci√≥n:</strong><br>
                                    <small style="color: #27ae60; font-weight: bold;">${ahora.toLocaleTimeString()}</small>
                                </div>
                                <div style="margin-top: 12px; padding-top: 8px; border-top: 1px solid #eee; text-align: center;">
                                    <small style="color: #8e44ad; font-weight: bold;">
                                        üì° Ubicaci√≥n GPS Activa
                                    </small>
                                </div>
                            </div>
                        `;
                        
                        userMarker.setPopupContent(tecnicoPopupActualizado);
                    }
                    
                    // Recargar m√≥viles
                    cargarMovilesCercanas(position.coords.latitude, position.coords.longitude);
                }
            );
        }
    }, 30000);
    
    // Inicializar cuando la p√°gina est√© lista
    document.addEventListener('DOMContentLoaded', function() {
        initMap();
    });
</script>
{% endblock %}